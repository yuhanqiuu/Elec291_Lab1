                  2   $LIST
0000              4   
0000              5   ;  N76E003 pinout:
0000              6   ;                               -------
0000              7   ;       PWM2/IC6/T0/AIN4/P0.5 -|1    20|- P0.4/AIN5/STADC/PWM3/IC3
0000              8   ;               TXD/AIN3/P0.6 -|2    19|- P0.3/PWM5/IC5/AIN6
0000              9   ;               RXD/AIN2/P0.7 -|3    18|- P0.2/ICPCK/OCDCK/RXD_1/[SCL]
0000             10   ;                    RST/P2.0 -|4    17|- P0.1/PWM4/IC4/MISO
0000             11   ;        INT0/OSCIN/AIN1/P3.0 -|5    16|- P0.0/PWM3/IC3/MOSI/T1
0000             12   ;              INT1/AIN0/P1.7 -|6    15|- P1.0/PWM2/IC2/SPCLK
0000             13   ;                         GND -|7    14|- P1.1/PWM1/IC1/AIN7/CLO
0000             14   ;[SDA]/TXD_1/ICPDA/OCDDA/P1.6 -|8    13|- P1.2/PWM0/IC0
0000             15   ;                         VDD -|9    12|- P1.3/SCL/[STADC]
0000             16   ;            PWM5/IC7/SS/P1.5 -|10   11|- P1.4/SDA/FB/PWM1
0000             17   ;                               -------
0000             18   ;
0000             19   
0000             20   CLK           EQU 16600000 ; Microcontroller system frequency in Hz
0000             21   TIMER0_RATE   EQU 2048     ; 2048Hz squarewave (peak amplitude of CEM-1203 speaker)
0000             22   TIMER0_RELOAD EQU ((65536-(CLK/TIMER0_RATE)))
0000             23   
0000             24   ;---------------------------------;
0000             25   ; Key board                       ;
0000             26   ;---------------------------------;
0000             27   C3_RATE equ 262
0000             28   C3_KEY EQU ((65536-(CLK/C3_RATE)))
0000             29   D3_RATE equ 294
0000             30   D3_KEY EQU ((65536-(CLK/D3_RATE)))
0000             31   B3_RATE equ 494
0000             32   B3_KEY EQU ((65536-(CLK/B3_RATE)))
0000             33   Gs3_RATE equ 415
0000             34   Gs3_KEY EQU ((65536-(CLK/Gs3_RATE)))
0000             35   A3_RATE equ 440
0000             36   A3_KEY EQU ((65536-(CLK/A3_RATE)))
0000             37   
0000             38   C4_RATE equ 523
0000             39   C4_KEY EQU ((65536-(CLK/C4_RATE)))
0000             40   D4_RATE equ 587
0000             41   D4_KEY EQU ((65536-(CLK/C4_RATE)))
0000             42   E4_RATE equ 479
0000             43   E4_KEY EQU ((65536-(CLK/E4_RATE)))
0000             44   Gs4_RATE equ 831
0000             45   Gs4_KEY EQU ((65536-(CLK/Gs4_RATE)))
0000             46   A4_RATE equ 880
0000             47   A4_KEY EQU ((65536-(CLK/A4_RATE)))
0000             48   B4_RATE equ 988
0000             49   B4_KEY EQU ((65536-(CLK/B4_RATE)))
0000             50   
0000             51   C5_RATE equ 1047
0000             52   C5_KEY EQU ((65536-(CLK/C5_RATE)))
0000             53   D5_RATE equ 1175
0000             54   D5_KEY EQU ((65536-(CLK/D5_RATE)))
0000             55   Ds5_RATE equ 1245
0000             56   Ds5_KEY EQU ((65536-(CLK/Ds5_RATE)))
0000             57   E5_RATE equ 1319
0000             58   E5_KEY EQU ((65536-(CLK/E5_RATE)))
0000             59   F5_RATE equ 1397
0000             60   F5_KEY EQU ((65536-(CLK/F5_RATE)))
0000             61   Fs5_RATE equ 1480
0000             62   Fs5_KEY EQU ((65536-(CLK/Fs5_RATE)))
0000             63   G5_RATE equ 1568
0000             64   G5_KEY EQU ((65536-(CLK/G5_RATE)))
0000             65   Gs5_RATE equ 1661
0000             66   Gs5_KEY EQU ((65536-(CLK/Gs5_RATE)))
0000             67   A5_RATE equ 1760
0000             68   A5_KEY EQU ((65536-(CLK/A5_RATE)))
0000             69   B5_RATE equ 1976
0000             70   B5_KEY EQU ((65536-(CLK/B5_RATE)))
0000             71   
0000             72   C6_RATE equ 2093
0000             73   C6_KEY EQU ((65536-(CLK/C6_RATE)))
0000             74   E6_RATE equ 2637
0000             75   E6_KEY EQU ((65536-(CLK/E6_RATE)))
0000             76   MUTE_KEY EQU 0
0000             77   ;----------------------------------
0000             78   SOUND_OUT     equ P1.7
0000             79   
0000             80   ; Reset vector
0000             81   org 0x0000
0000 020122      82       ljmp main
0003             83   
0003             84   ; External interrupt 0 vector (not used in this code)
0003             85   org 0x0003
0003 32          86            reti
0004             87   
0004             88   ; Timer/Counter 0 overflow interrupt vector
000B             89   org 0x000B
000B 020115      90            ljmp Timer0_ISR
000E             91   
000E             92   ; External interrupt 1 vector (not used in this code)
0013             93   org 0x0013
0013 32          94            reti
0014             95   
0014             96   ; Timer/Counter 1 overflow interrupt vector (not used in this code)
001B             97   org 0x001B
001B 32          98            reti
001C             99   
001C            100   ; Serial port receive/transmit interrupt vector (not used in this code)
0023            101   org 0x0023 
0023 32         102            reti
0024            103   
0024            104   
0024            105   ; In the 8051 we can define direct access variables starting at location 0x30 up to location 0x7F
0030            106   dseg at 0x30
0030            107   Count1ms:     ds 2 ; Used to determine when half second has passed
0032            108   Melody_Reload: ds 2
0034            109   ; In the 8051 we have variables that are 1-bit in size.  We can use the setb, clr, jb, and jnb
0034            110   ; instructions with these variables.  This is how you define a 1-bit variable:
0000            111   bseg
0000            112   half_seconds_flag: dbit 1 ; Set to one in the ISR every time 500 ms had passed
0001            113   
0024            114   cseg
0024            115   ; These 'equ' must match the hardware wiring
0024            116   LCD_RS equ P1.3
0024            117   ;LCD_RW equ PX.X ; Not used in this code, connect the pin to GND
0024            118   LCD_E  equ P1.4
0024            119   LCD_D4 equ P0.0
0024            120   LCD_D5 equ P0.1
0024            121   LCD_D6 equ P0.2
0024            122   LCD_D7 equ P0.3
0024            123   
                125   $LIST
00F6            127   
00F6            128   ;                     1234567890123456    <- This helps determine the location of the counter
00F6 20203E4D   129   Initial_Message:  db '  >Music Test<  ', 0
     75736963
     20546573
     743C2020
     00
0107            130   
0107            131   ;---------------------------------;
0107            132   ; Routine to initialize the ISR   ;
0107            133   ; for timer 0                     ;
0107            134   ;---------------------------------;
0107            135   Timer0_Init:
0107 438E08     136            orl CKCON, #0b00001000 ; Input for timer 0 is sysclk/1
010A E589       137            mov a, TMOD
010C 54F0       138            anl a, #0xf0 ; 11110000 Clear the bits for timer 0
010E 4401       139            orl a, #0x01 ; 00000001 Configure timer 0 as 16-timer
0110 F589       140            mov TMOD, a
0112            141            ;mov TH0, #high(B3_KEY)
0112            142            ;mov TL0, #low(B3_KEY)
0112            143            ; Enable the timer and interrupts
0112            144       ;setb ET0  ; Enable timer 0 interrupt
0112 D28C       145       setb TR0  ; Start timer 0
0114 22         146            ret
0115            147   
0115            148   ;---------------------------------;
0115            149   ; ISR for timer 0.  Set to execute;
0115            150   ; every 1/4096Hz to generate a    ;
0115            151   ; 2048 Hz wave at pin SOUND_OUT   ;
0115            152   ;---------------------------------;
0115            153   Timer0_ISR:
0115            154            ;clr TF0  ; According to the data sheet this is done for us already.
0115            155            ; Timer 0 doesn't have 16-bit auto-reload, so
0115 C28C       156            clr TR0
0117            157            ;mov TH0, #high(TIMER0_RELOAD)
0117            158            ;mov TL0, #low(TIMER0_RELOAD)
0117 85338C     159            mov TH0, Melody_Reload+1
011A 85328A     160            mov TL0, Melody_Reload+0
011D D28C       161            setb TR0
011F B297       162            cpl SOUND_OUT ; Connect speaker the pin assigned to 'SOUND_OUT'!
0121 32         163            reti
0122            164            
0122            165   ;---------------------------------;
0122            166   ; Main program. Includes hardware ;
0122            167   ; initialization and 'forever'    ;
0122            168   ; loop.                           ;
0122            169   ;---------------------------------;
0122            170   main:
0122            171            ; Initialization
0122 75817F     172       mov SP, #0x7F
0125 75B100     173       mov P0M1, #0x00
0128 75B200     174       mov P0M2, #0x00
012B 75B300     175       mov P1M1, #0x00
012E 75B400     176       mov P1M2, #0x00
0131 75AD00     177       mov P3M2, #0x00
0134 75AD00     178       mov P3M2, #0x00
0137            179       
0137 D2AF       180       setb EA   ; Enable Global interrupts
0139 12007D     181       lcall LCD_4BIT
013C C083       182            push dph
013E C082       182            push dpl
0140 C0E0       182            push acc
0142 9000F6     182            mov dptr, #Initial_Message
0145 1200B0     182            lcall ?Send_Constant_String
0148 D0E0       182            pop acc
014A D082       182            pop dpl
014C D083       182            pop dph
014E            183   
014E            184   Turkish_March:
014E 120107     185            lcall Timer0_Init
0151            186            ;setb ET0
0151 75337C     187       mov Melody_Reload+1, #high(B3_KEY)
0154 7532BD     188            mov Melody_Reload+0, #low(B3_KEY)
0157 C002       189            push AR2
0159 7A78       189            mov R2, #120
015B 12002E     189            lcall ?Wait_Milli_Seconds
015E D002       189            pop AR2
0160            190   
0160 75336C     191            mov Melody_Reload+1, #high(A3_KEY)
0163 7532A1     192            mov Melody_Reload+0, #low(A3_KEY)
0166 C002       193            push AR2
0168 7A78       193            mov R2, #120
016A 12002E     193            lcall ?Wait_Milli_Seconds
016D D002       193            pop AR2
016F            194   
016F 753363     195            mov Melody_Reload+1, #high(Gs3_KEY)
0172 7532C0     196            mov Melody_Reload+0, #low(Gs3_KEY)
0175 C002       197            push AR2
0177 7A78       197            mov R2, #120
0179 12002E     197            lcall ?Wait_Milli_Seconds
017C D002       197            pop AR2
017E            198            
017E 75336C     199            mov Melody_Reload+1, #high(A3_KEY)
0181 7532A1     200            mov Melody_Reload+0, #low(A3_KEY)
0184 C002       201            push AR2
0186 7A78       201            mov R2, #120
0188 12002E     201            lcall ?Wait_Milli_Seconds
018B D002       201            pop AR2
018D            202   ;----------------------------------------
018D 753384     203            mov Melody_Reload+1, #high(C4_KEY)
0190 753205     204            mov Melody_Reload+0, #low(C4_KEY)
0193 C002       205            push AR2
0195 7AF0       205            mov R2, #240
0197 12002E     205            lcall ?Wait_Milli_Seconds
019A D002       205            pop AR2
019C C002       206            push AR2
019E 7AF0       206            mov R2, #240
01A0 12002E     206            lcall ?Wait_Milli_Seconds
01A3 D002       206            pop AR2
01A5 D2A9       207            setb ET0
01A7 753384     208            mov Melody_Reload+1, #high(D4_KEY)
01AA 753205     209            mov Melody_Reload+0, #low(D4_KEY)
01AD C002       210            push AR2
01AF 7A78       210            mov R2, #120
01B1 12002E     210            lcall ?Wait_Milli_Seconds
01B4 D002       210            pop AR2
01B6            211   
01B6 753384     212            mov Melody_Reload+1, #high(C4_KEY)
01B9 753205     213            mov Melody_Reload+0, #low(C4_KEY)
01BC C002       214            push AR2
01BE 7A78       214            mov R2, #120
01C0 12002E     214            lcall ?Wait_Milli_Seconds
01C3 D002       214            pop AR2
01C5            215   
01C5 7533BE     216            mov Melody_Reload+1, #high(B4_KEY)
01C8 75325F     217            mov Melody_Reload+0, #low(B4_KEY)
01CB C002       218            push AR2
01CD 7A78       218            mov R2, #120
01CF 12002E     218            lcall ?Wait_Milli_Seconds
01D2 D002       218            pop AR2
01D4            219   
01D4 7533C2     220            mov Melody_Reload+1, #high(C5_KEY)
01D7 753212     221            mov Melody_Reload+0, #low(C5_KEY)
01DA C002       222            push AR2
01DC 7A78       222            mov R2, #120
01DE 12002E     222            lcall ?Wait_Milli_Seconds
01E1 D002       222            pop AR2
01E3            223   
01E3 7533CE     224            mov Melody_Reload+1, #high(E5_KEY)
01E6 7532D7     225            mov Melody_Reload+0, #low(E5_KEY)
01E9 C002       226            push AR2
01EB 7AF0       226            mov R2, #240
01ED 12002E     226            lcall ?Wait_Milli_Seconds
01F0 D002       226            pop AR2
01F2 C002       227            push AR2
01F4 7AF0       227            mov R2, #240
01F6 12002E     227            lcall ?Wait_Milli_Seconds
01F9 D002       227            pop AR2
01FB            228   ;-----------------------------------------
01FB 7533D1     229            mov Melody_Reload+1, #high(F5_KEY)
01FE 753296     230            mov Melody_Reload+0, #low(F5_KEY)
0201 C002       231            push AR2
0203 7A78       231            mov R2, #120
0205 12002E     231            lcall ?Wait_Milli_Seconds
0208 D002       231            pop AR2
020A            232   
020A 7533CE     233            mov Melody_Reload+1, #high(E5_KEY)
020D 7532D7     234            mov Melody_Reload+0, #low(E5_KEY)
0210 C002       235            push AR2
0212 7A78       235            mov R2, #120
0214 12002E     235            lcall ?Wait_Milli_Seconds
0217 D002       235            pop AR2
0219            236   
0219 7533CB     237            mov Melody_Reload+1, #high(Ds5_KEY)
021C 7532EB     238            mov Melody_Reload+0, #low(Ds5_KEY)
021F C002       239            push AR2
0221 7A78       239            mov R2, #120
0223 12002E     239            lcall ?Wait_Milli_Seconds
0226 D002       239            pop AR2
0228            240   
0228 7533CE     241            mov Melody_Reload+1, #high(E5_KEY)
022B 7532D7     242            mov Melody_Reload+0, #low(E5_KEY)
022E C002       243            push AR2
0230 7A78       243            mov R2, #120
0232 12002E     243            lcall ?Wait_Milli_Seconds
0235 D002       243            pop AR2
0237            244   ;-----------------------------------------
0237 7533DF     245            mov Melody_Reload+1, #high(B5_KEY)
023A 753230     246            mov Melody_Reload+0, #low(B5_KEY)
023D C002       247            push AR2
023F 7A78       247            mov R2, #120
0241 12002E     247            lcall ?Wait_Milli_Seconds
0244 D002       247            pop AR2
0246            248   
0246 7533DB     249            mov Melody_Reload+1, #high(A5_KEY)
0249 753229     250            mov Melody_Reload+0, #low(A5_KEY)
024C C002       251            push AR2
024E 7A78       251            mov R2, #120
0250 12002E     251            lcall ?Wait_Milli_Seconds
0253 D002       251            pop AR2
0255            252   
0255 7533D8     253            mov Melody_Reload+1, #high(Gs5_KEY)
0258 7532F7     254            mov Melody_Reload+0, #low(Gs5_KEY)
025B C002       255            push AR2
025D 7A78       255            mov R2, #120
025F 12002E     255            lcall ?Wait_Milli_Seconds
0262 D002       255            pop AR2
0264            256   
0264 7533DB     257            mov Melody_Reload+1, #high(A5_KEY)
0267 753229     258            mov Melody_Reload+0, #low(A5_KEY)
026A C002       259            push AR2
026C 7A78       259            mov R2, #120
026E 12002E     259            lcall ?Wait_Milli_Seconds
0271 D002       259            pop AR2
0273            260   ;--------------------------------------
0273 7533DF     261            mov Melody_Reload+1, #high(B5_KEY)
0276 753230     262            mov Melody_Reload+0, #low(B5_KEY)
0279 C002       263            push AR2
027B 7A78       263            mov R2, #120
027D 12002E     263            lcall ?Wait_Milli_Seconds
0280 D002       263            pop AR2
0282            264   
0282 7533DB     265            mov Melody_Reload+1, #high(A5_KEY)
0285 753229     266            mov Melody_Reload+0, #low(A5_KEY)
0288 C002       267            push AR2
028A 7A78       267            mov R2, #120
028C 12002E     267            lcall ?Wait_Milli_Seconds
028F D002       267            pop AR2
0291            268   
0291 7533D8     269            mov Melody_Reload+1, #high(Gs5_KEY)
0294 7532F7     270            mov Melody_Reload+0, #low(Gs5_KEY)
0297 C002       271            push AR2
0299 7A78       271            mov R2, #120
029B 12002E     271            lcall ?Wait_Milli_Seconds
029E D002       271            pop AR2
02A0            272   
02A0 7533DB     273            mov Melody_Reload+1, #high(A5_KEY)
02A3 753229     274            mov Melody_Reload+0, #low(A5_KEY)
02A6 C002       275            push AR2
02A8 7A78       275            mov R2, #120
02AA 12002E     275            lcall ?Wait_Milli_Seconds
02AD D002       275            pop AR2
02AF            276   
02AF 7533E1     277            mov Melody_Reload+1, #high(C6_KEY)
02B2 753205     278            mov Melody_Reload+0, #low(C6_KEY)
02B5 C002       279            push AR2
02B7 7AF0       279            mov R2, #240
02B9 12002E     279            lcall ?Wait_Milli_Seconds
02BC D002       279            pop AR2
02BE C002       280            push AR2
02C0 7AF0       280            mov R2, #240
02C2 12002E     280            lcall ?Wait_Milli_Seconds
02C5 D002       280            pop AR2
02C7            281            
02C7            282   ;----------------------------------------
02C7 7533DB     283            mov Melody_Reload+1, #high(A5_KEY)
02CA 753229     284            mov Melody_Reload+0, #low(A5_KEY)
02CD C002       285            push AR2
02CF 7AF0       285            mov R2, #240
02D1 12002E     285            lcall ?Wait_Milli_Seconds
02D4 D002       285            pop AR2
02D6            286   
02D6 7533E1     287            mov Melody_Reload+1, #high(C6_KEY)
02D9 753205     288            mov Melody_Reload+0, #low(C6_KEY)
02DC C002       289            push AR2
02DE 7AF0       289            mov R2, #240
02E0 12002E     289            lcall ?Wait_Milli_Seconds
02E3 D002       289            pop AR2
02E5            290   ;-----------------------------------------
02E5 7533DF     291            mov Melody_Reload+1, #high(B5_KEY)
02E8 753230     292            mov Melody_Reload+0, #low(B5_KEY)
02EB C002       293            push AR2
02ED 7AF0       293            mov R2, #240
02EF 12002E     293            lcall ?Wait_Milli_Seconds
02F2 D002       293            pop AR2
02F4            294   
02F4 7533DB     295            mov Melody_Reload+1, #high(A5_KEY)
02F7 753229     296            mov Melody_Reload+0, #low(A5_KEY)
02FA C002       297            push AR2
02FC 7AF0       297            mov R2, #240
02FE 12002E     297            lcall ?Wait_Milli_Seconds
0301 D002       297            pop AR2
0303            298   
0303 7533D6     299            mov Melody_Reload+1, #high(G5_KEY)
0306 753229     300            mov Melody_Reload+0, #low(A5_KEY)
0309 C002       301            push AR2
030B 7AF0       301            mov R2, #240
030D 12002E     301            lcall ?Wait_Milli_Seconds
0310 D002       301            pop AR2
0312            302   
0312 7533DB     303            mov Melody_Reload+1, #high(A5_KEY)
0315 753229     304            mov Melody_Reload+0, #low(A5_KEY)
0318 C002       305            push AR2
031A 7AF0       305            mov R2, #240
031C 12002E     305            lcall ?Wait_Milli_Seconds
031F D002       305            pop AR2
0321            306   ;-----------------------------------------
0321 7533DF     307            mov Melody_Reload+1, #high(B5_KEY)
0324 753230     308            mov Melody_Reload+0, #low(B5_KEY)
0327 C002       309            push AR2
0329 7AF0       309            mov R2, #240
032B 12002E     309            lcall ?Wait_Milli_Seconds
032E D002       309            pop AR2
0330            310   
0330 7533DB     311            mov Melody_Reload+1, #high(A5_KEY)
0333 753229     312            mov Melody_Reload+0, #low(A5_KEY)
0336 C002       313            push AR2
0338 7AF0       313            mov R2, #240
033A 12002E     313            lcall ?Wait_Milli_Seconds
033D D002       313            pop AR2
033F            314   
033F 7533D6     315            mov Melody_Reload+1, #high(G5_KEY)
0342 753229     316            mov Melody_Reload+0, #low(A5_KEY)
0345 C002       317            push AR2
0347 7AF0       317            mov R2, #240
0349 12002E     317            lcall ?Wait_Milli_Seconds
034C D002       317            pop AR2
034E            318   
034E 7533DB     319            mov Melody_Reload+1, #high(A5_KEY)
0351 753229     320            mov Melody_Reload+0, #low(A5_KEY)
0354 C002       321            push AR2
0356 7AF0       321            mov R2, #240
0358 12002E     321            lcall ?Wait_Milli_Seconds
035B D002       321            pop AR2
035D            322   ;-----------------------------------------
035D 7533DF     323            mov Melody_Reload+1, #high(B5_KEY)
0360 753230     324            mov Melody_Reload+0, #low(B5_KEY)
0363 C002       325            push AR2
0365 7AF0       325            mov R2, #240
0367 12002E     325            lcall ?Wait_Milli_Seconds
036A D002       325            pop AR2
036C            326   
036C 7533DB     327            mov Melody_Reload+1, #high(A5_KEY)
036F 753229     328            mov Melody_Reload+0, #low(A5_KEY)
0372 C002       329            push AR2
0374 7AF0       329            mov R2, #240
0376 12002E     329            lcall ?Wait_Milli_Seconds
0379 D002       329            pop AR2
037B            330   
037B 7533D6     331            mov Melody_Reload+1, #high(G5_KEY)
037E 753229     332            mov Melody_Reload+0, #low(A5_KEY)
0381 C002       333            push AR2
0383 7AF0       333            mov R2, #240
0385 12002E     333            lcall ?Wait_Milli_Seconds
0388 D002       333            pop AR2
038A            334            
038A 7533D4     335            mov Melody_Reload+1, #high(Fs5_KEY)
038D 753230     336            mov Melody_Reload+0, #low(Fs5_KEY)
0390 C002       337            push AR2
0392 7AF0       337            mov R2, #240
0394 12002E     337            lcall ?Wait_Milli_Seconds
0397 D002       337            pop AR2
0399            338   
0399 7533CE     339            mov Melody_Reload+1, #high(E5_KEY)
039C 7532D7     340            mov Melody_Reload+0, #low(E5_KEY)
039F C002       341            push AR2
03A1 7AF0       341            mov R2, #240
03A3 12002E     341            lcall ?Wait_Milli_Seconds
03A6 D002       341            pop AR2
03A8 C002       342            push AR2
03AA 7AF0       342            mov R2, #240
03AC 12002E     342            lcall ?Wait_Milli_Seconds
03AF D002       342            pop AR2
03B1            343   
03B1            344   forever:
03B1 C28C       345            clr TR0
03B3 80FC       346            sjmp forever
03B5            347   END
